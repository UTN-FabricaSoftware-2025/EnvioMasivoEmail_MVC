trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  webProject: 'EnvioMasivoEmail_MVC/EnvioMasivoEmail_MVC.csproj'
  syncToolProject: 'AzureTestSyncApp/AzureTestSyncApp.csproj'
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  # OPTIMIZATION: Disable Telemetry and Logos for slightly faster CLI startup
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1

steps:
# 1. Cache NuGet Packages
- task: Cache@2
  displayName: 'Cache NuGet packages'
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/*.csproj,!**/bin/**,!**/obj/**'
    restoreKeys: |
       nuget | "$(Agent.OS)"
    path: $(NUGET_PACKAGES)

# 2. Restore dependencies
- task: DotNetCoreCLI@2
  displayName: 'Restore All Dependencies'
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

# 3. Build the Console App (Sync Tool)
- task: DotNetCoreCLI@2
  displayName: 'Build Sync Tool'
  inputs:
    command: 'build'
    projects: '$(syncToolProject)'
    # OPTIMIZATION: Output to a known directory for direct execution
    arguments: '--configuration $(buildConfiguration) --no-restore --output $(Build.BinariesDirectory)/SyncTool'

# 4. EXECUTE the Console App (Directly, no "dotnet run" overhead)
- script: |
    dotnet "$(Build.BinariesDirectory)/SyncTool/AzureTestSyncApp.dll"
  displayName: 'Run AzureTestSyncApp Direct'
  workingDirectory: 'AzureTestSyncApp'
  env:
    PERSONAL_ACCESS_TOKEN: $(MyAzurePAT) 
    ORGANIZATION_URL: 'https://dev.azure.com/UTN-FabricaSoftware-2025'
    PROJECT_NAME: 'CorreosMasivos'
    PLAN_ID: '38'

# 5. Publish the Web App
- task: DotNetCoreCLI@2
  displayName: 'Publish Web App'
  inputs:
    command: 'publish'
    projects: '$(webProject)'
    publishWebProjects: false 
    arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --no-restore'
    zipAfterPublish: true

# 6. Deploy to Azure
- task: AzureWebApp@1
  displayName: 'Azure Web App Deploy'
  inputs:
    azureSubscription: 'AzureConnection' 
    appType: 'webApp'
    appName: 'correos-masivos' 
    package: '$(Build.ArtifactStagingDirectory)/**/*.zip'